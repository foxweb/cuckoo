# cuckoo

Сервис для отправки оригинальных текстов в [Яндекс.Вебмастер](http://webmasters.yandex.ru/) через [Yandex API](http://api.yandex.ru/webmaster/).

> Если вы публикуете на своем сайте оригинальные тексты, а их перепечатывают другие интернет-ресурсы, предупредите Яндекс о скором выходе текста. Мы будем знать, что оригинальный текст впервые появился именно на вашем сайте, и попробуем использовать это в настройке поисковых алгоритмов.

> Пожалуйста, загружайте только оригинальные тексты, которые до сих пор не были опубликованы в интернете. Рекомендуемый минимальный объем – 500 знаков, максимальный — 32000 знаков. Вы можете размещать текст на сайте сразу после отправки заявки.

## Быстрый старт

``` sh
$ bundle install
$ mv config/config.yml.example config/config.yml
$ vim config/config.yml # выставляем APP_ID и APP_PASSWORD
$ ruby cuckoo.rb

$ open http://localhost:4567/
```
## Использование утилиты

1. Прежде чем начинать использование этой утилиты — зарегистрируйте ваше приложение в Yandex API по адресу https://oauth.yandex.ru/.
2. Установите приложение и настройте `config.yml`.
3. Запустите приложение командой `ruby cuckoo.rb`
4. Перед отправкой текстов нужно авторизовать приложение и получить токен. Для этого нужно просто зайти на `http://localhost:4567/`
5. Если клиент не авторизован, то случится редирект с запросом на авторизацию. Если авторизован — выведется проверочное сообщение вида:

  ```
  Access token: b213f90d2abe4cdf9bbadc3cba4f36fb
  ```

6. Теперь можно отправлять оригинальный тексты в Яндекс POST-запросом с оригинальным текстом на URL `http://localhost:4567/hosts/:host_id/original-texts/`.

  Пример с использованием [httpie](https://github.com/jakubroztocil/httpie):

  ``` sh
  $ http -f POST http://localhost:4567/hosts/123456789/original-texts original_text="Hello world * 100 times"
  ```
  
  Если происходит ошибка — проверьте длину отправляемого текста — от 500 до 32000 знаков.
  Статус отправки и сообщения об ошибках приходят в теле ответа от Яндекса.
  Для демонстрации в данном приложении в ответ на POST-запрос отдаётся проверочная информация: host_id, отправленный текст и тело ответа от Яндекса.
  Исправьте вывод на нужный именно вам.
  
  `host_id` можно найти в панели управления Яндекс.Вебмастер. Ссылки на ваши сайты содержат этот `host_id`. Пример: http://webmaster.yandex.ru/site/?host=123456789.
  Вообще, их правильно получать через API, но ниже написано, почему это не сделано.

## Известные проблемы

1. Для простоты здесь не используются расширенные возможности Faraday и библиотеки оборачивания в XML. Вы можете использовать Nokogiri или кастомный Faraday middleware для более удобного оборачивания в XML.
2. Используется не полностью рабочая версия гема [yandex-webmaster](https://github.com/foxweb/yandex-webmaster). По хорошему, весь функционал API реализован там, но гем заброшен и потерял актуальность.
   Там нет поддержки оригинальных текстов и не работает получение списка сайтов в Вебмастере.
   В данном приложении задействован только функционал авторизации.
3. Поскольку авторизация проходит через браузер, то непросто отлаживать приложение в консоли без сохранения сессий.
   Для обхода этого ограничения в 44 строке `cuckoo.rb` используется параметр `settings.demo_token` из файла конфигурации.
4. Тестов нет.

## Ссылки
* [Авторизация клиента в Yandex API](https://oauth.yandex.ru/)
* [Добавление оригинального текста](http://api.yandex.ru/webmaster/doc/dg/reference/host-original-texts-add.xml)
* [Вопросы и ответы по оригинальным текстам](http://help.yandex.ru/webmaster/authored-texts/faq.xml)
